@page "/oggettivisitatore/{IdVisitatore:int}"

<h3>Oggetti acquistati da @NomeVisitatore  @CognomeVisitatore</h3>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th scope="col">Codice</th>
            <th scope="col">Tipo</th>
            <th scope="col">Materiale principale</th>
            <th scope="col">Epoca</th>
            <th scope="col">Prezzo</th>
            <th scope="col">Stand</th>
            <th scope="col">Dettagli</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in myList) //per ogni oggetto nella lista scrivo i valori su una riga
        {
            <tr>
                <th scope="row">@item.idOggetto</th>
                <td>@item.tipo</td>
                <td>@((item.materialePrincipale == "") ? "Non presente" : item.materialePrincipale)</td>
                <td>@((item.epoca == "") ? "Non presente" : item.epoca + " secolo")</td>
                <td>@item.prezzoEsposto €</td>
                <td>@item.standId</td>
                <td><a href="/dettagliooggetto/@item.idOggetto">Dettagli</a></td>
            </tr>
        }
    </tbody>
</table>

@code {
    [Parameter]
    public int IdVisitatore { get; set; }

    string NomeVisitatore;
    string CognomeVisitatore;

    List<Oggetto> myList = new List<Oggetto>();

    private void CaricaDatiArchivio()
    {
        myList.Clear();

        string connString = "Data Source=Data/dbAntiquariato.db";
        SqliteConnection myConn = new SqliteConnection(connString);
        SqliteCommand myCommand = new SqliteCommand($"SELECT * FROM tblOggetti WHERE visitatoreId = {IdVisitatore};");
        SqliteDataReader myDr;
        myCommand.Connection = myConn;


        myConn.Open();
        myDr = myCommand.ExecuteReader();

        while (myDr.Read())
        {
            Oggetto nuovoOggetto = new Oggetto
                {
                    idOggetto = Convert.ToInt32(myDr["idOggetto"]),
                    tipo = Convert.ToString(myDr["tipo"]),
                    materialePrincipale = Convert.ToString(myDr["materialePrincipale"]),
                    epoca = Convert.ToString(myDr["epoca"]),
                    prezzoEsposto = Convert.ToDecimal(myDr["prezzoEsposto"]),
                    standId = Convert.ToInt32(myDr["standId"])
                };
            myList.Add(nuovoOggetto);
        }
        myConn.Close();


        myCommand = new SqliteCommand($"SELECT * FROM tblVisitatori WHERE idVisitatore = {IdVisitatore};");
        myCommand.Connection = myConn;
        myConn.Open();
        myDr = myCommand.ExecuteReader();

        while (myDr.Read())
        {
            NomeVisitatore = Convert.ToString(myDr["nome"]);
            CognomeVisitatore = Convert.ToString(myDr["cognome"]);
        }
        myConn.Close();
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        CaricaDatiArchivio();
    }
}
